<!DOCTYPE html>
<html lang="ja">
<head>
  <title>EatKano ランキング</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0" />
  <link href="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 56px; /* Navbar height */ } /* Navbarがfixed-topの場合 */
    .list-group-item small:first-of-type { /* 日付用のsmallタグ */
        color: #6c757d;
    }
    .list-group-item p {
        font-size: 0.9rem;
        color: #495057;
    }
    .rank-badge {
        font-size: 0.8rem;
        margin-right: 0.5rem;
        padding: 0.3em 0.6em;
    }
    #leaderboard .list-group-item {
        padding: 0.75rem 1.25rem;
    }
    .footer-record {
        padding:0.5em 1em;
        background-color: #f8f9fa; /* bg-light */
        border-top: 1px solid #dee2e6;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container">
      <a class="navbar-brand" href="./">EatKano</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-type="all">総合ランキング</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-type="day">デイリー</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-type="week">ウィークリー</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-type="month">マンスリー</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/arcxingye/EatKano/" target="_blank">ソースコード</a>
          </li>
        </ul>
        <form class="d-flex text-nowrap" id="searchForm">
          <input class="form-control me-2" id="searchInput" placeholder="名前で検索...">
          <button class="btn btn-outline-success" type="submit">検索</button>
        </form>
      </div>
    </div>
  </nav>

  <div class="container mt-4" style="max-width:720px;">
    <div class="page-header text-center">
      <br />
      <h1 id="rankingTitle">総合ランキング</h1><br />
    </div>
    <div id="leaderboard" class="list-group">
      <!-- ランキングデータはここに挿入されます -->
    </div>
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center" id="pagination">
        <!-- ページネーションはここに挿入されます -->
      </ul>
    </nav>
  </div>

  <footer class='fixed-bottom container' style='max-width:720px; margin: 0 auto;'>
    <div class='row shadow rounded bg-light'>
      <div id="selfRecord" class="footer-record text-center">
        <!-- 自己ベスト記録はここに挿入されます -->
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/js/bootstrap.bundle.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://pazuftgivpsfqekecfvt.supabase.co/'; // 提供されたURLに修正
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhenVmdGdpdnBzZnFla2VjZnZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NzUwNTUsImV4cCI6MjA2MjM1MTA1NX0.m_N4lzEf6rbSqN18oDre4MCx8MteakGfyvv9vs3p5EY'; // 提供されたキーに修正
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

    const ITEMS_PER_PAGE = 10;
    let currentPage = 1;
    let currentRankingType = 'all'; // 'all', 'day', 'week', 'month', 'query'
    let currentQuery = '';
    let totalItems = 0;

    // 国際化用文字列 (簡易版)
    const i18n = {
      'all-rank': '総合ランキング',
      'day-rank': 'デイリーランキング',
      'week-rank': 'ウィークリーランキング',
      'month-rank': 'マンスリーランキング',
      'query-record': '検索結果',
      'no-data': '該当するデータがありません。',
      'self-record': '{name}さんの記録: スコア {score} ( {time} )',
      'no-self-record': '{name}さんの記録は見つかりませんでした。',
      'no-name-tip': 'ゲームをプレイしてあなたの名前を記録に残そう！',
      'error-loading': 'ランキングの読み込みに失敗しました。'
    };

    const leaderboardElement = document.getElementById('leaderboard');
    const paginationElement = document.getElementById('pagination');
    const rankingTitleElement = document.getElementById('rankingTitle');
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    const selfRecordElement = document.getElementById('selfRecord');
    const navLinks = document.querySelectorAll('.navbar-nav .nav-link[data-type]');

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    function getRankSuffix(rank) {
        if (rank % 100 >= 11 && rank % 100 <= 13) return 'th';
        switch (rank % 10) {
            case 1: return 'st';
            case 2: return 'nd';
            case 3: return 'rd';
            default: return 'th';
        }
    }
    
    function cookie(name, value, time) {
        function toStr(obj) {
            if (typeof obj === 'object') {
                return JSON.stringify(obj);
            } else {
                return obj;
            }
        }
        if (name) {
            if (value !== undefined) { // valueが指定された場合（設定）
                if (time) {
                    let date = new Date();
                    date.setTime(date.getTime() + 864e5 * time);
                    time = date.toGMTString();
                }
                return document.cookie = name + "=" + escape(toStr(value)) + (time ? "; expires=" + time + "; path=/" : "; path=/"), true;
            }
            // valueが指定されない場合（取得）
            let v = document.cookie.match("(?:^|;)\\s*" + name.replace(/([-.*+?^${}()|[\]\/\\])/g, "\\$1") + "=([^;]*)");
            v = v && "string" == typeof v[1] ? unescape(v[1]) : false;
            if (v && (/^(\{|\[).+\}|\]$/.test(v) || /^[0-9]+$/g.test(v))) {
                try {
                    eval("v=" + v);
                } catch (e) { /* evalエラーは無視 */ }
            }
            return v;
        }
        // nameが指定されない場合（すべて取得）
        let data = {};
        value = document.cookie.replace(/\s/g, "").split(";");
        for (let i = 0; value.length > i; i++) {
            name = value[i].split("=");
            if (name[1]) {
                try {
                    data[name[0]] = unescape(name[1]);
                } catch (e) {
                    data[name[0]] = name[1]; // unescapeエラーの場合、元の値を保持
                }
            }
        }
        return data;
    }


    async function loadRanking() {
      leaderboardElement.innerHTML = `<div class="list-group-item text-center">読み込み中...</div>`;
      paginationElement.innerHTML = '';

      let query = supabase
        .from('leaderboard')
        .select('name, score, comment, created_at', { count: 'exact' }); // count: 'exact' で総件数を取得

      // ランキング種別によるフィルタ
      const now = new Date();
      if (currentRankingType === 'day') {
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        query = query.gte('created_at', todayStart);
        rankingTitleElement.textContent = i18n['day-rank'];
      } else if (currentRankingType === 'week') {
        const weekAgo = new Date(new Date().setDate(now.getDate() - 7)).toISOString(); // 常に現在から7日前を計算
        query = query.gte('created_at', weekAgo);
        rankingTitleElement.textContent = i18n['week-rank'];
      } else if (currentRankingType === 'month') {
        const monthAgo = new Date(new Date().setMonth(now.getMonth() - 1)).toISOString(); // 常に現在から1ヶ月前を計算
        query = query.gte('created_at', monthAgo);
        rankingTitleElement.textContent = i18n['month-rank'];
      } else if (currentRankingType === 'query' && currentQuery) {
        query = query.ilike('name', `%${currentQuery}%`); // ilikeで大文字小文字を区別しない検索
        rankingTitleElement.textContent = i18n['query-record'] + `: ${currentQuery}`;
      } else { // all
        rankingTitleElement.textContent = i18n['all-rank'];
      }

      // スコアで降順ソート
      query = query.order('score', { ascending: false });

      // ページネーション
      const offset = (currentPage - 1) * ITEMS_PER_PAGE;
      query = query.range(offset, offset + ITEMS_PER_PAGE - 1);
      
      try {
        const { data, error, count } = await query;

        if (error) {
          console.error('ランキング読み込みエラー:', error);
          leaderboardElement.innerHTML = `<div class="list-group-item list-group-item-danger">${i18n['error-loading']} (詳細: ${error.message})</div>`;
          return;
        }

        totalItems = count || 0; // 総件数を更新

        if (data.length === 0) {
          leaderboardElement.innerHTML = `<div class="list-group-item text-center">${i18n['no-data']}</div>`;
        } else {
          leaderboardElement.innerHTML = ''; // 前のデータをクリア
          data.forEach((r, index) => {
            const rank = offset + index + 1;
            const li = document.createElement('a');
            li.href = '#'; // クリックイベントは特に設定しない
            li.className = 'list-group-item list-group-item-action';
            // PHP版のスタイルに近づける
            li.innerHTML = `
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">
                  <span class="badge bg-primary rank-badge">${rank}${getRankSuffix(rank)}</span>
                  ${r.name || '名無し'}
                </h5>
                <small>${formatDate(r.created_at)}</small>
              </div>
              <p class="mb-1 ms-1">SCORE: <strong>${r.score}</strong></p>
              ${r.comment ? `<small class="text-muted ms-1">コメント: ${r.comment}</small>` : ''}
            `;
            leaderboardElement.appendChild(li);
          });
        }
        renderPagination();
      } catch (e) {
          console.error('ランキング処理エラー:', e);
          leaderboardElement.innerHTML = `<div class="list-group-item list-group-item-danger">${i18n['error-loading']}</div>`;
      }
    }

    function renderPagination() {
      paginationElement.innerHTML = '';
      const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

      if (totalPages <= 1) return;

      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      const prevA = document.createElement('a');
      prevA.className = 'page-link';
      prevA.href = '#';
      prevA.innerHTML = '«';
      prevA.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage > 1) {
          currentPage--;
          loadRanking();
        }
      });
      prevLi.appendChild(prevA);
      paginationElement.appendChild(prevLi);

      // Page numbers
      // PHP版の max_pages (9) のような制限を設ける場合
      const maxPagesToShow = 9;
      let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
      let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
      
      if (endPage - startPage + 1 < maxPagesToShow && totalPages >= maxPagesToShow) {
          if (startPage === 1) {
              endPage = Math.min(totalPages, maxPagesToShow);
          } else {
              startPage = Math.max(1, totalPages - maxPagesToShow + 1);
          }
      }


      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = i;
        a.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage = i;
          loadRanking();
        });
        li.appendChild(a);
        paginationElement.appendChild(li);
      }

      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      const nextA = document.createElement('a');
      nextA.className = 'page-link';
      nextA.href = '#';
      nextA.innerHTML = '»';
      nextA.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage < totalPages) {
          currentPage++;
          loadRanking();
        }
      });
      nextLi.appendChild(nextA);
      paginationElement.appendChild(nextLi);
    }

    async function loadSelfRecord() {
      const username = cookie('username'); // index.js と同じcookie関数を利用
      if (username) {
        try {
          const { data, error } = await supabase
            .from('leaderboard')
            .select('score, created_at')
            .eq('name', username)
            .order('score', { ascending: false })
            .limit(1);

          if (error) {
            console.error('自己ベスト読み込みエラー:', error);
            selfRecordElement.textContent = i18n['no-name-tip']; // エラー時もデフォルト表示
            return;
          }

          if (data && data.length > 0) {
            const record = data[0];
            selfRecordElement.innerHTML = i18n['self-record']
              .replace('{name}', username)
              .replace('{score}', record.score)
              .replace('{time}', formatDate(record.created_at));
          } else {
            selfRecordElement.textContent = i18n['no-self-record'].replace('{name}', username);
          }
        } catch (e) {
            console.error('自己ベスト処理エラー:', e);
            selfRecordElement.textContent = i18n['no-name-tip'];
        }
      } else {
        selfRecordElement.textContent = i18n['no-name-tip'];
      }
    }
    
    // ナビゲーションリンクのイベントリスナー
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        
        currentRankingType = link.dataset.type;
        currentPage = 1; // タイプ変更時は1ページ目に戻す
        currentQuery = ''; // 通常のランキングタイプ選択時は検索クエリをクリア
        searchInput.value = ''; // 検索入力欄もクリア
        loadRanking();
      });
    });

    // 検索フォームのイベントリスナー
    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const queryText = searchInput.value.trim();
      if (queryText) {
        currentRankingType = 'query';
        currentQuery = queryText;
        currentPage = 1;
        // アクティブなナビゲーションリンクをクリア
        navLinks.forEach(l => l.classList.remove('active'));
        loadRanking();
      } else {
        // 検索文字が空の場合は総合ランキングに戻すなど
        currentRankingType = 'all';
        currentQuery = '';
        navLinks.forEach(l => l.classList.remove('active'));
        document.querySelector('.navbar-nav .nav-link[data-type="all"]').classList.add('active'); // 総合をアクティブに
        loadRanking();
      }
    });

    // 初期読み込み
    loadRanking();
    loadSelfRecord();

  </script>
</body>
</html>